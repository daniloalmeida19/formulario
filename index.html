<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário Empresárial</title>
    <link rel="shortcut icon" href="icones/lista-de-controle.gif" type="image/x-icon">
    <link rel="stylesheet" href="estilo.css">
</head>
<body>

    <h1 id="nome">Formulário da Empresa Romano</h1>

    <nav>
        <ul>

            <li><a href="cadastrar-cliente.html">Cadastrar Cliente</a></li>

            <li><a href="index.html" class="active">Cadastrar Produto</a></li>
            
            <li><a href="produtos.html">Ver Estoque</a></li>

            <li><a href="saida.html">Registrar Saída</a></li>

            <li><a href="relatorios.html">Relatórios</a></li>

            <li><a href="clientes.html">Clientes</a></li>
            
        </ul>
    </nav>
    <header>
        <h1>Formulário de Cadastro de Produtos</h1>
        <p>Insira os dados do produto para cadastrar no sistema.</p>
        <br>
        <a href="estoque-baixo.html">Produtos com Estoque Baixo</a>
        <br>

        <video src="icones/caderno.mp4" width="150" height="150" autoplay loop muted controls>
            Seu navegador não suporta o elemento de vídeo.
        </video>
    </header>
    <main>
        <form id="product-form">
            <fieldset>
                <legend>Informações do Produto</legend>

                <div>
                    <label for="nome-produto">Nome do Produto:</label><br>
                    <input type="text" id="nome-produto" name="nome_produto" list="lista-produtos" placeholder="Digite ou selecione o nome do produto" required>
                    <datalist id="lista-produtos">
                        <option value="Camiseta Branca">
                        <option value="Calça Jeans">
                        <option value="Tênis Esportivo">
                        <option value="Moletom Preto">
                        <option value="Bermuda Tactel">
                        <option value="Vestido Floral">
                        <option value="Sapato Social">
                        <option value="Jaqueta de Couro">
                        <option value="Óculos de Sol">
                        <option value="Relógio de Pulso">
                        <option value="Camisa Polo">
                        <option value="Saia Jeans">
                        <option value="Boné">
                        <option value="Bolsa">
                    </datalist>
                </div>
                <br>
                <div>
                    <label for="estoque">Quantidade em Estoque:</label><br>
                    <input type="number" id="estoque" name="estoque" min="0" placeholder="Ex: 100" required>
                    <small id="alerta-estoque" style="color: red; display: none;">Atenção: Estoque baixo!</small>
                </div>
                <br>
                <div>
                    <label for="valor-compra">Preço de Compra (R$):</label><br>
                    <input type="number" id="valor-compra" name="valor_compra" min="0.01" step="0.01" placeholder="Ex: 29.90" required>
                </div>
                <br>
                <div>
                    <label for="valor-venda">Preço de Venda (R$):</label><br>
                    <input type="number" id="valor-venda" name="valor_venda" min="0.01" step="0.01" placeholder="Ex: 49.90" required>
                </div>
            </fieldset>
            <br>
            <button type="submit">Cadastrar Produto</button>
        </form>
        <br>
        <a href="produtos.html">Ver Produtos Cadastrados</a>

        <script>
            const productForm = document.getElementById('product-form');
            const estoqueInput = document.getElementById('estoque');
            const alertaEstoque = document.getElementById('alerta-estoque');

            // Verifica se há um ID na URL para edição
            const urlParams = new URLSearchParams(window.location.search);
            const produtoIdEditar = urlParams.get('id');

            if (produtoIdEditar) {
                const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
                const produto = produtos.find(p => p.id === produtoIdEditar);
                if (produto) {
                    const inputNome = document.getElementById('nome-produto');
                    inputNome.value = produto.nome;
                    inputNome.disabled = true; // Bloqueia a troca do produto durante a edição
                    
                    document.getElementById('estoque').value = produto.quantidade;
                    document.getElementById('valor-compra').value = produto.valorCompra;
                    document.getElementById('valor-venda').value = produto.valorVenda;

                    document.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
                    document.querySelector('header h1').textContent = 'Editar Produto';
                }
            }

            // Adiciona um "ouvinte" para o alerta de estoque baixo
            estoqueInput.addEventListener('input', function() {
                const quantidade = parseInt(this.value, 10);
                const limiteEstoqueBaixo = 10;
                alertaEstoque.style.display = (quantidade <= limiteEstoqueBaixo && this.value !== '') ? 'block' : 'none';
            });

            // Adiciona um "ouvinte" para o envio do formulário
            productForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Impede o envio padrão do formulário

                // Pega os valores dos campos
                const nomeProdutoInput = document.getElementById('nome-produto');
                const nomeProduto = nomeProdutoInput.value.trim();
                // Gera um ID baseado no nome (ex: "Calça Jeans" -> "calca-jeans")
                const produtoId = nomeProduto.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');

                const quantidade = parseInt(document.getElementById('estoque').value, 10);
                const valorCompra = parseFloat(document.getElementById('valor-compra').value).toFixed(2);
                const valorVenda = parseFloat(document.getElementById('valor-venda').value).toFixed(2);

                // Pega os produtos já salvos no localStorage ou cria uma lista vazia
                const produtosSalvos = JSON.parse(localStorage.getItem('produtos')) || [];
                
                // Lógica de Edição (Substituição dos dados)
                if (produtoIdEditar) {
                    const index = produtosSalvos.findIndex(p => p.id === produtoIdEditar);
                    if (index !== -1) {
                        produtosSalvos[index].quantidade = quantidade; // Substitui a quantidade (correção)
                        produtosSalvos[index].valorCompra = valorCompra;
                        produtosSalvos[index].valorVenda = valorVenda;
                        
                        localStorage.setItem('produtos', JSON.stringify(produtosSalvos));
                        alert('Produto atualizado com sucesso!');
                        window.location.href = 'produtos.html';
                        return;
                    }
                }

                // Verifica se o produto já existe
                const indexExistente = produtosSalvos.findIndex(p => p.id === produtoId);

                if (indexExistente !== -1) {
                    // Se existe, soma a quantidade e atualiza os preços
                    produtosSalvos[indexExistente].quantidade = parseInt(produtosSalvos[indexExistente].quantidade) + quantidade;
                    produtosSalvos[indexExistente].valorCompra = valorCompra;
                    produtosSalvos[indexExistente].valorVenda = valorVenda;
                    alert('Produto já existente! Estoque atualizado com sucesso.');
                } else {
                    // Se não existe, cria um novo
                    const produto = {
                        id: produtoId,
                        nome: nomeProduto,
                        quantidade: quantidade,
                        valorCompra: valorCompra,
                        valorVenda: valorVenda
                    };
                    produtosSalvos.push(produto);
                    alert('Produto cadastrado com sucesso!');
                }

                localStorage.setItem('produtos', JSON.stringify(produtosSalvos));

                productForm.reset(); // Limpa o formulário
            });
        </script>
    </main>
</body>
</html>