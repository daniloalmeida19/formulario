<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes</title>
    <link rel="shortcut icon" href="icones/lista-de-controle.gif" type="image/x-icon">
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="index.html">Cadastrar Produto</a></li>
            <li><a href="cadastrar-cliente.html">Cadastrar Cliente</a></li>
            <li><a href="produtos.html">Ver Estoque</a></li>
            <li><a href="saida.html">Registrar Saída</a></li>
            <li><a href="relatorios.html">Relatórios</a></li>
            <li><a href="clientes.html" class="active">Clientes</a></li>
        </ul>
    </nav>
    <header>
        <h1>Clientes Cadastrados</h1>
    </header>
    <main>
        <h2>Lista de Clientes</h2>
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Endereço</th>
                    <th>Telefone</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="lista-clientes-cadastrados">
                <!-- Os dados dos clientes cadastrados serão inseridos aqui via JavaScript -->
            </tbody>
        </table>

        <hr style="margin: 40px 0;">

        <h2>Histórico de Compras por Cliente</h2>
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Produto Comprado</th>
                    <th>Quantidade</th>
                    <th>Valor Total (R$)</th>
                    <th>Data da Compra</th>
                </tr>
            </thead>
            <tbody id="historico-compras">
                <!-- O histórico de compras será inserido aqui via JavaScript -->
            </tbody>
        </table>

        <div class="actions-container">
            <a href="index.html" class="btn-finalizar">Finalizar</a>
            <a href="https://wa.me/5511941233423?text=Ol%C3%A1,%20gostaria%20de%20mais%20informa%C3%A7%C3%B5es" target="_blank" class="btn-whatsapp">Falar no WhatsApp</a>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const listaClientesCadastrados = document.getElementById('lista-clientes-cadastrados');
            const historicoCompras = document.getElementById('historico-compras');

            // Carrega e exibe os clientes cadastrados
            let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            if (clientes.length === 0) {
                listaClientesCadastrados.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado ainda.</td></tr>';
            } else {
                clientes.forEach(cliente => {
                    const row = listaClientesCadastrados.insertRow();
                    row.dataset.id = cliente.id; // Adiciona ID para facilitar a exclusão

                    row.insertCell(0).textContent = cliente.nome;
                    row.insertCell(1).textContent = cliente.endereco;
                    row.insertCell(2).textContent = cliente.telefone;

                    const actionCell = row.insertCell(3);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Excluir';
                    deleteButton.className = 'delete-btn';
                    actionCell.appendChild(deleteButton);
                });
            }

            // Lógica para exclusão de cliente
            listaClientesCadastrados.addEventListener('click', function(event) {
                if (event.target.classList.contains('delete-btn')) {
                    if (confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) {
                        const row = event.target.closest('tr');
                        const clienteId = row.dataset.id;

                        // Remove do array e atualiza o localStorage
                        clientes = clientes.filter(c => c.id !== clienteId);
                        localStorage.setItem('clientes', JSON.stringify(clientes));

                        // Remove a linha da tabela na tela
                        row.remove();

                        // Se for o último cliente, mostra a mensagem
                        if (clientes.length === 0) {
                            listaClientesCadastrados.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum cliente cadastrado ainda.</td></tr>';
                        }
                    }
                }
            });

            // Carrega e exibe o histórico de vendas
            const vendas = JSON.parse(localStorage.getItem('vendas')) || [];
            
            // Ordena as vendas por data, da mais recente para a mais antiga
            vendas.sort((a, b) => new Date(b.data) - new Date(a.data));

            let vendasExibidas = 0;

            vendas.forEach(venda => {
                if (venda.cliente) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${venda.cliente.nome}</td>
                        <td>${venda.produtoNome}</td>
                        <td>${venda.quantidade}</td>
                        <td>R$ ${parseFloat(venda.valorTotal).toFixed(2)}</td>
                        <td>${new Date(venda.data).toLocaleDateString('pt-BR')}</td>
                    `;
                    historicoCompras.appendChild(row);
                    vendasExibidas++;
                }
            });

            if (vendasExibidas === 0) {
                historicoCompras.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma venda registrada ainda.</td></tr>';
            }
        });
    </script>
</body>
</html>
